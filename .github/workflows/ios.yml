name: iOS CI/CD

on:
  push:
    branches:
      - develop    # TestFlight (DEV)
      - main    # App Store (PROD)

env:
  # Match (Ïù∏Ï¶ùÏÑú)
  MATCH_GIT_URL:  ${{ secrets.MATCH_GIT_URL }}
  MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
  APPLE_ID:       ${{ secrets.APPLE_ID }}
  TEAM_ID:        ${{ secrets.TEAM_ID }}
  CI_KEYCHAIN_PASSWORD:  ${{ secrets.CI_KEYCHAIN_PASSWORD }}

  # App Store Connect
  APP_STORE_CONNECT_KEY_ID:       ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
  APP_STORE_CONNECT_ISSUER_ID:    ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
  APP_STORE_CONNECT_PRIVATE_KEY:  ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}

jobs:
  build:
    runs-on: macos-14

    steps:
      # --------------------------------
      # Checkout
      # --------------------------------
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # --------------------------------
      # Xcode
      # --------------------------------
      - name: Use Xcode 16.2
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      # --------------------------------
      # AWS OIDC (SSM Ï†ëÍ∑º)
      # --------------------------------
      # DEV Î∏åÎûúÏπòÏö©
      - name: Configure AWS credentials (DEV)
        if: github.ref == 'refs/heads/dev'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::590052531747:role/github-actions-workaway-ios-dev
          aws-region: ap-northeast-2

      # PROD Î∏åÎûúÏπòÏö©
      - name: Configure AWS credentials (PROD)
        if: github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::590052531747:role/github-actions-workaway-ios-prod
          aws-region: ap-northeast-2

      # --------------------------------
      # SSH (match repo)
      # --------------------------------
      - name: Start ssh-agent & add deploy key
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Ensure known_hosts for GitHub
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # --------------------------------
      # Node
      # --------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Node dependencies
        run: yarn install

      # --------------------------------
      # Ruby / Fastlane
      # --------------------------------
      - name: Set up Ruby & Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1
          bundler-cache: true

      - name: Install Ruby gems
        working-directory: ios
        run: bundle install

      # --------------------------------
      # CocoaPods
      # --------------------------------
      - name: Install CocoaPods 1.15.2
        run: gem install cocoapods -v 1.15.2

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: pod _1.15.2_ install --repo-update

      # --------------------------------
      # ENV Î∂ÑÍ∏∞ + SSM Î°úÎî© (‚≠ê ÌïµÏã¨)
      # --------------------------------
      - name: Load iOS env from AWS SSM
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [ "$BRANCH" = "develop" ]; then
            ENV=dev
            LANE=beta        # TestFlight
          else
            ENV=prod
            LANE=release     # App Store
          fi

          BASE_PATH="/workaway/$ENV/ios"

          echo "üì¶ Loading env from $BASE_PATH"

          cat <<EOF > ios/.env
          API_BASE_URL=$(aws ssm get-parameter --name $BASE_PATH/API_BASE_URL --with-decryption --query Parameter.Value --output text)
          PORTONE_STORE_ID=$(aws ssm get-parameter --name $BASE_PATH/PORTONE_STORE_ID --with-decryption --query Parameter.Value --output text)
          PORTONE_REDIRECT_URL=$(aws ssm get-parameter --name $BASE_PATH/PORTONE_REDIRECT_URL --with-decryption --query Parameter.Value --output text)
          PORTONE_NOTICE_URL=$(aws ssm get-parameter --name $BASE_PATH/PORTONE_NOTICE_URL --with-decryption --query Parameter.Value --output text)
          PORTONE_CHANNEL_KEY=$(aws ssm get-parameter --name $BASE_PATH/PORTONE_CHANNEL_KEY --with-decryption --query Parameter.Value --output text)
          KAKAO_JS_KEY=$(aws ssm get-parameter --name $BASE_PATH/KAKAO_JS_KEY --with-decryption --query Parameter.Value --output text)
          KAKAO_NATIVEAPP_KEY=$(aws ssm get-parameter --name $BASE_PATH/KAKAO_NATIVEAPP_KEY --with-decryption --query Parameter.Value --output text)
          KAKAO_RESTAPI_KEY=$(aws ssm get-parameter --name $BASE_PATH/KAKAO_RESTAPI_KEY --with-decryption --query Parameter.Value --output text)
          EOF

          cp ios/.env .env
          echo "LANE=$LANE" >> $GITHUB_ENV
          
      # --------------------------------
      # Build & Upload
      # --------------------------------
      - name: Build & Deploy iOS
        working-directory: ios
        env:
          CI: "true"
        run: |
          echo "üöÄ Fastlane lane: $LANE"
          bundle exec fastlane $LANE
