default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # (필요 시) 특정 Xcode 버전을 명시하고 싶으면 uncomment
    # xcode_select "/Applications/Xcode_15.4.app"

    # CI용 키체인 설정
    setup_ci(force: true)

    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_PRIVATE_KEY"],
      duration: 1200,
      in_house: false
    )

    # DerivedData 클린
    sh "rm -rf ~/Library/Developer/Xcode/DerivedData"

    # React Native JS 번들링
    sh <<-SHELL
      cd ..
      yarn react-native bundle \
        --platform ios \
        --dev false \
        --entry-file index.js \
        --bundle-output ios/trioFrontendApp/main.jsbundle \
        --assets-dest ios/trioFrontendApp
    SHELL

    # Xcode 빌드
    build_app(
      workspace: "trioFrontendApp.xcworkspace",
      scheme:    "trioFrontendApp",
      clean:     false,

      # ─── 반드시 export_method를 따로 지정 ───
      export_method: "app-store",

      export_options: {
        compileBitcode:        false,
        provisioningProfiles: {
          # Bundle ID  => 프로파일 이름
          "com.haneul.workaway" => "WorkAwayAppStoreProfile"
        }
      },

      output_directory: ".",
      output_name:      "trioFrontendApp.ipa",
      silent:           false
    )

    # TestFlight 업로드
    upload_to_testflight(api_key: api_key)
  end
end
