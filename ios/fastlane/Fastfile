default_platform(:ios)

platform :ios do
  # --------------------------------------------------
  # Í≥µÌÜµ ÏÑ§Ï†ï
  # --------------------------------------------------
  before_all do
    puts "üìÅ Fastlane dir: #{Dir.pwd}"

    env_path = File.expand_path("../.env")
    UI.user_error!("‚ùå .env not found") unless File.exist?(env_path)

    puts "üì¶ Loading env from #{env_path}"

    File.foreach(env_path) do |line|
      key, value = line.strip.split("=", 2)
      ENV[key] = value if key && value
    end

    # CI Ï†ÑÏö© ÌÇ§Ï≤¥Ïù∏
    create_keychain(
      name: "ci-build.keychain",
      password: ENV["CI_KEYCHAIN_PASSWORD"],
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )

    ENV["MATCH_KEYCHAIN_NAME"]     = "ci-build.keychain"
    ENV["MATCH_KEYCHAIN_PASSWORD"] = ENV["CI_KEYCHAIN_PASSWORD"]
  end

  # --------------------------------------------------
  # Í≥µÌÜµ ÎπåÎìú Î°úÏßÅ
  # --------------------------------------------------
  private_lane :build_common do |options|
    scheme_name = options[:scheme]

    UI.message("üöÄ Build scheme: #{scheme_name}")
    UI.message("üåê API_BASE_URL: #{ENV['API_BASE_URL']}")

    increment_version_number(version_number: "1.9")
    increment_build_number(build_number: Time.now.strftime("%Y%m%d%H%M"))

    match(
      type: "appstore",
      readonly: ENV["CI"] == "true",
      git_url: ENV["MATCH_GIT_URL"],
      username: ENV["APPLE_ID"],
      team_id: ENV["TEAM_ID"],
      keychain_name: ENV["MATCH_KEYCHAIN_NAME"],
      keychain_password: ENV["MATCH_KEYCHAIN_PASSWORD"]
    )
    # Ïù¥Ï†Ñ JS bundle ÏôÑÏ†Ñ ÏÇ≠Ï†ú
    sh <<-SHELL
      echo "üßπ Cleaning old JS bundle"
      rm -rf ios/trioFrontendApp/main.jsbundle
      rm -rf ios/trioFrontendApp/assets
    SHELL

    # Î≤àÎì§ ÏãúÏ†ê ÌôòÍ≤ΩÎ≥ÄÏàò Í≤ÄÏ¶ù
    sh <<-SHELL
      echo "üî• API_BASE_URL during bundle: $API_BASE_URL"
    SHELL


    sh <<-SHELL
      echo "üì¶ Using ENVFILE: #{File.expand_path("../.env")}"

      export ENVFILE=#{File.expand_path("../.env")}
      cd ..
      yarn react-native bundle \
        --platform ios \
        --dev false \
        --entry-file index.js \
        --bundle-output ios/trioFrontendApp/main.jsbundle \
        --assets-dest ios/trioFrontendApp
    SHELL

    build_app(
      workspace: "trioFrontendApp.xcworkspace",
      scheme: scheme_name,
      configuration: "Release",
      clean: true,
      export_method: "app-store",
      xcargs: "-allowProvisioningUpdates",
      export_xcargs: "-allowProvisioningUpdates",
      output_directory: "../output",
      output_name: "trioFrontendApp.ipa"
    )
  end

  # --------------------------------------------------
  # TestFlight (DEV)
  # --------------------------------------------------
  desc "TestFlight build (DEV)"
  lane :beta do
    build_common(
      scheme: "WorkAway-Dev"
    )

    upload_to_testflight(
      api_key: app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_PRIVATE_KEY"]
      ),
      ipa: "../output/trioFrontendApp.ipa",
      skip_waiting_for_build_processing: true
    )
  end

  # --------------------------------------------------
  # App Store (PROD)
  # --------------------------------------------------
  desc "App Store release (PROD)"
  lane :release do
    build_common(
      scheme: "WorkAway-Prod"
    )

    upload_to_testflight(
      api_key: app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_PRIVATE_KEY"]
      ),
      ipa: "../output/trioFrontendApp.ipa",
      skip_waiting_for_build_processing: true
    )
  end
end
