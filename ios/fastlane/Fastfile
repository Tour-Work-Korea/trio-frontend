default_platform(:ios)

platform :ios do
  desc "Build IPA (JS 번들링 + Archive)"
  lane :build_ipa do
    # JS 번들링
    sh <<-SHELL
      cd ..
      yarn react-native bundle \
        --platform ios \
        --dev false \
        --entry-file index.js \
        --bundle-output ios/trioFrontendApp/main.jsbundle \
        --assets-dest ios/trioFrontendApp
    SHELL

    build_app(
      workspace: "trioFrontendApp.xcworkspace",
      scheme:    "trioFrontendApp",
      clean:     false,
      export_method: "app-store",
      export_options: {
        compileBitcode: false,
        provisioningProfiles: {
          "com.haneul.workaway" => "WorkAwayAppStoreProfile"
        },
        teamID: "59P3UT5738"
      },
      output_directory: "../output",       # 예: 상위 폴더에 output 디렉터리 지정
      output_name:      "trioFrontendApp.ipa",
      xcargs: "CODE_SIGNING_ALLOWED=NO CODE_SIGN_IDENTITY=\"\""
    )
  end

  desc "Upload existing IPA to TestFlight"
  lane :upload_ipa do
    api_key = app_store_connect_api_key(
      key_id:     ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id:  ENV["APP_STORE_CONNECT_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_PRIVATE_KEY"],
      duration:   1200,
      in_house:   false
    )

    upload_to_testflight(
      api_key:       api_key,
      ipa:           "../output/trioFrontendApp.ipa",
      skip_waiting_for_build_processing: true  # 빌드 프로세싱 완료 대기 없이 바로 종료
    )
  end
end
